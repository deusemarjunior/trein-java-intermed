openapi: 3.0.3
info:
  title: Movie Service API
  description: |
    Microsserviço de Filmes — Desafio Consultoria.
    Consome a API do TheMovieDB e expõe endpoints para busca, detalhes, favoritos e "assistir depois".
    O frontend TheMovie Web (React) consome esta API.
  version: 1.0.0

servers:
  - url: http://localhost:8080
    description: Servidor local

tags:
  - name: Movies
    description: Endpoints de filmes (busca, detalhes, populares, favoritos)
  - name: Auth
    description: Autenticação JWT

paths:
  /api/movies/search:
    get:
      tags: [Movies]
      summary: Buscar filmes por texto
      operationId: searchMovies
      parameters:
        - name: query
          in: query
          required: true
          description: Texto de busca (ex. "Matrix")
          schema:
            type: string
        - name: page
          in: query
          required: false
          description: Número da página (padrão 1)
          schema:
            type: integer
            default: 1
      responses:
        '200':
          description: Lista paginada de filmes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MoviePage'

  /api/movies/popular:
    get:
      tags: [Movies]
      summary: Listar filmes populares
      operationId: getPopularMovies
      parameters:
        - name: page
          in: query
          required: false
          schema:
            type: integer
            default: 1
      responses:
        '200':
          description: Lista paginada de filmes populares
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MoviePage'

  /api/movies/{id}:
    get:
      tags: [Movies]
      summary: Detalhes de um filme
      operationId: getMovieDetails
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Detalhes do filme com status de favorito/watchLater
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Movie'
        '404':
          description: Filme não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

  /api/movies/{id}/favorite:
    post:
      tags: [Movies]
      summary: Favoritar um filme
      operationId: addFavorite
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '201':
          description: Filme favoritado com sucesso
        '409':
          description: Filme já está nos favoritos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '422':
          description: Limite máximo de favoritos atingido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
      security:
        - BearerAuth: []

    delete:
      tags: [Movies]
      summary: Remover filme dos favoritos
      operationId: removeFavorite
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: Filme removido dos favoritos
      security:
        - BearerAuth: []

  /api/movies/{id}/watch-later:
    post:
      tags: [Movies]
      summary: Marcar filme para assistir depois
      operationId: addWatchLater
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '201':
          description: Filme marcado para assistir depois
      security:
        - BearerAuth: []

  /api/movies/favorites:
    get:
      tags: [Movies]
      summary: Listar filmes favoritos do usuário (paginado)
      operationId: getFavorites
      parameters:
        - name: page
          in: query
          required: false
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          required: false
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Lista paginada de filmes favoritos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FavoritePage'
      security:
        - BearerAuth: []

  /auth/login:
    post:
      tags: [Auth]
      summary: Autenticação — obter token JWT
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Token JWT gerado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Credenciais inválidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Movie:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 603
        title:
          type: string
          example: "Matrix"
        overview:
          type: string
          example: "Um hacker descobre que a realidade..."
        posterPath:
          type: string
          example: "/f89U3ADr1oiB1s9GkdPOEpXUk5H.jpg"
        backdropPath:
          type: string
          example: "/fNG7i7RqMErkcqhohV2a6cV1Ehy.jpg"
        releaseDate:
          type: string
          example: "1999-03-31"
        voteAverage:
          type: number
          format: double
          example: 8.2
        voteCount:
          type: integer
          example: 24521
        popularity:
          type: number
          format: double
          example: 78.456
        favorite:
          type: boolean
          example: false
        watchLater:
          type: boolean
          example: false

    MoviePage:
      type: object
      properties:
        movies:
          type: array
          items:
            $ref: '#/components/schemas/Movie'
        page:
          type: integer
          example: 1
        totalPages:
          type: integer
          example: 5
        totalResults:
          type: integer
          format: int64
          example: 96

    FavoritePage:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/Movie'
        page:
          type: integer
        size:
          type: integer
        totalElements:
          type: integer
          format: int64
        totalPages:
          type: integer

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: "user@movie.com"
        password:
          type: string
          example: "123456"

    TokenResponse:
      type: object
      properties:
        token:
          type: string
          example: "eyJhbGciOiJIUzI1NiJ9..."
        type:
          type: string
          example: "Bearer"
        expiresIn:
          type: integer
          format: int64
          example: 3600

    ProblemDetail:
      type: object
      properties:
        type:
          type: string
          example: "about:blank"
        title:
          type: string
          example: "Not Found"
        status:
          type: integer
          example: 404
        detail:
          type: string
          example: "Filme não encontrado com ID: 999"
        instance:
          type: string
          example: "/api/movies/999"
